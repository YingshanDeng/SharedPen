!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).SharedPen=t()}}(function(){return function t(e,n,r){function i(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var h=n[s]={exports:{}};e[s][0].call(h.exports,function(t){var n=e[s][1][t];return i(n||t)},h,h.exports,t,e,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=t("./Utils.js"),s=function(){function t(e,n){r(this,t),this.pos=e,this.length=n}return i(t,[{key:"end",value:function(){return this.pos+this.length}}]),t}(),a=function(){function t(e,n){r(this,t),this.pos=e,this.length=n.length,this.annotation=n.annotation,this.attachedObject_=n.attachedObject}return i(t,[{key:"getAttachedObject",value:function(){return this.attachedObject_}}]),t}(),u=function(){function t(e,n){r(this,t),this.pos=e,this.length=n.length,this.annotation=n.annotation,this.node_=n}return i(t,[{key:"attachObject",value:function(t){this.node_.attachedObject=t}}]),t}(),l=function(){function t(e,n){r(this,t),this.length=e,this.annotation=n,this.attachedObject=null,this.next=null}return i(t,[{key:"clone",value:function(){var e=new t(this.spanLength,this.annotation);return e.next=this.next,e}}]),t}(),h={equals:function(){return!1}},c=function(){function t(e){r(this,t),this.head_=new l(0,h),this.changeHandler_=e}return i(t,[{key:"insertAnnotatedSpan",value:function(t,e){this.wrapOperation_(new s(t.pos,0),function(n,r){o.assert(!r||null===r.next);var i=new l(t.length,e);if(r){o.assert(t.pos>n&&t.pos<n+r.length);var s=new l(0,h);return s.next=new l(t.pos-n,r.annotation),s.next.next=i,i.next=new l(n+r.length-t.pos,r.annotation),s.next}return i})}},{key:"removeSpan",value:function(t){0!==t.length&&this.wrapOperation_(t,function(e,n){o.assert(null!==n);var r=new l(0,h),i=r;for(t.pos>e&&(i.next=new l(t.pos-e,n.annotation),i=i.next);t.end()>e+n.length;)e+=n.length,n=n.next;var s=e+n.length-t.end();return s>0&&(i.next=new l(s,n.annotation)),r.next})}},{key:"updateSpan",value:function(t,e){0!==t.length&&this.wrapOperation_(t,function(n,r){o.assert(null!==r);var i=new l(0,h),s=i,a=n,u=t.pos-a;for(o.assert(u<r.length),u>0&&(s.next=new l(u,r.annotation),a+=(s=s.next).length);null!==r&&t.end()>=n+r.length;){var c=n+r.length-a;s.next=new l(c,e(r.annotation,c)),s=s.next,n+=r.length,r=r.next,a=n}var f=t.end()-a;return f>0&&(o.assert(f<r.length),s.next=new l(f,e(r.annotation,f)),a+=(s=s.next).length,s.next=new l(n+r.length-a,r.annotation)),i.next})}},{key:"forEach",value:function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next}},{key:"getAnnotatedSpansForPos",value:function(t){for(var e=0,n=this.head_.next,r=null;null!==n&&e+n.length<=t;)e+=n.length,r=n,n=n.next;if(null===n&&e!==t)throw new Error("pos exceeds the bounds of the AnnotationList");var i=[];return e===t&&r&&i.push(new a(e-r.length,r)),n&&i.push(new a(e,n)),i}},{key:"getAnnotatedSpansForSpan",value:function(t){if(0===t.length)return[];for(var e=[],n=this.getAffectedNodes_(t),r=n.startPos,i=n.start;null!==i&&r<t.end();){var o=Math.max(r,t.pos),a=Math.min(r+i.length,t.end()),u=new s(o,a-o);u.annotation=i.annotation,e.push(u),r+=i.length,i=i.next}return e}},{key:"wrapOperation_",value:function(t,e){if(t.pos<0)throw new Error("Span start cannot be negative.");var n,r=[],i=[],o=this.getAffectedNodes_(t);null!==o.start?(n=o.end.next,o.end.next=null):n=o.succ;var s=e(o.startPos,o.start),h=!1,c=!1;if(s){this.mergeNodesWithSameAnnotations_(s);var f;for(o.pred&&o.pred.annotation.equals(s.annotation)?(h=!0,s.length+=o.pred.length,o.beforePred.next=s,f=o.predPos):(o.beforeStart.next=s,f=o.startPos);s.next;)i.push(new u(f,s)),f+=s.length,s=s.next;o.succ&&o.succ.annotation.equals(s.annotation)?(s.length+=o.succ.length,c=!0,s.next=o.succ.next):s.next=n,i.push(new u(f,s))}else o.pred&&o.succ&&o.pred.annotation.equals(o.succ.annotation)?(h=!0,c=!0,s=new l(o.pred.length+o.succ.length,o.pred.annotation),o.beforePred.next=s,s.next=o.succ.next,i.push(new u(o.startPos-o.pred.length,s))):o.beforeStart.next=n;h&&r.push(new a(o.predPos,o.pred));for(var d=o.startPos,p=o.start;null!==p;)r.push(new a(d,p)),d+=p.length,p=p.next;c&&r.push(new a(d,o.succ)),this.changeHandler_(r,i)}},{key:"getAffectedNodes_",value:function(t){for(var e={},n=null,r=this.head_,i=r.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,n=r,r=i,i=i.next;if(null===i&&(0!==t.length||t.pos!==o))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,0===t.length&&t.pos===o?e.start=null:e.start=i,e.beforeStart=r,o===t.pos&&o>0?(e.pred=r,e.predPos=o-r.length,e.beforePred=n):e.pred=null;null!==i&&t.end()>o;)o+=i.length,r=i,i=i.next;if(t.end()>o)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===t.length&&t.end()===o?e.end=null:e.end=r,e.succ=o===t.end()?i:null,e}},{key:"mergeNodesWithSameAnnotations_",value:function(t){if(t)for(var e=null,n=t;n;)e&&e.annotation.equals(n.annotation)?(e.length+=n.length,e.next=n.next):e=n,n=n.next}},{key:"count",value:function(){for(var t=0,e=this.head_.next,n=null;null!==e;)n&&o.assert(!n.annotation.equals(e.annotation)),n=e,e=e.next,t++;return t}}]),t}();e.exports={Span:s,AnnotationList:c}},{"./Utils.js":14}],2:[function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=t("./TextOperation.js"),s=function(){function t(e,n){r(this,t),this.revision=e,this.historyOps=n,this.state=u}return i(t,[{key:"initClientContent",value:function(){if(this.historyOps&&this.historyOps.length){var t=this.historyOps.map(function(t){return t.wrapped}),e=new o;t.forEach(function(t){var n=o.fromJSON(t);e=e.compose(n)}),this.applyOperation(e)}}},{key:"sendOperation",value:function(t,e){throw new Error("sendOperation must be defined in child class")}},{key:"applyOperation",value:function(t){throw new Error("applyOperation must be defined in child class")}},{key:"setState",value:function(t){this.state=t}},{key:"applyClient",value:function(t){this.setState(this.state.applyClient(this,t))}},{key:"applyServer",value:function(t){this.revision++,this.setState(this.state.applyServer(this,t))}},{key:"serverAck",value:function(){this.revision++,this.setState(this.state.serverAck(this))}},{key:"serverReconnect",value:function(){"function"==typeof this.state.resend&&this.setState(this.state.resend(this))}},{key:"transformSelection",value:function(t){return this.state.transformSelection(t)}}]),t}(),a=function(){function t(){r(this,t)}return i(t,[{key:"applyClient",value:function(t,e){return t.sendOperation(t.revision,e),new l(e)}},{key:"applyServer",value:function(t,e){return t.applyOperation(e),this}},{key:"serverAck",value:function(t){throw new Error("There is no pending operation.")}},{key:"transformSelection",value:function(t){return t}}]),t}(),u=new a,l=function(){function t(e){r(this,t),this.outstanding=e}return i(t,[{key:"applyClient",value:function(t,e){return new h(this.outstanding,e)}},{key:"applyServer",value:function(e,n){var r=this.outstanding.transform(n);return e.applyOperation(r[1]),new t(r[0])}},{key:"serverAck",value:function(t){return u}},{key:"resend",value:function(t){t.sendOperation(t.revision,this.outstanding)}},{key:"transformSelection",value:function(t){return t.transform(this.outstanding)}}]),t}(),h=function(){function t(e,n){r(this,t),this.outstanding=e,this.buffer=n}return i(t,[{key:"applyClient",value:function(e,n){var r=this.buffer.compose(n);return new t(this.outstanding,r)}},{key:"applyServer",value:function(e,n){var r=this.outstanding.transform(n),i=this.buffer.transform(r[1]);return e.applyOperation(i[1]),new t(r[0],i[0])}},{key:"serverAck",value:function(t){return t.sendOperation(t.revision,this.buffer),new l(this.buffer)}},{key:"resend",value:function(t){t.sendOperation(t.revision,this.outstanding)}},{key:"transformSelection",value:function(t){return t.transform(this.outstanding).transform(this.buffer)}}]),t}();e.exports={Client:s,Synchronized:a,AwaitingConfirm:l,AwaitingWithBuffer:h}},{"./TextOperation.js":12}],3:[function(t,e,n){"use strict";var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();e.exports=function(){function t(e){var n=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.socket=e,e.on("client_join",function(t){n.trigger("client_join",t)}).on("client_left",function(t){n.trigger("client_left",t)}).on("set_name",function(t,e){n.trigger("set_name",t,e)}).on("ack",function(){n.trigger("ack")}).on("operation",function(t,e,r){n.trigger("operation",e),n.trigger("selection",t,r)}).on("selection",function(t,e){n.trigger("selection",t,e)}).on("disconnect",function(t){n.trigger("disconnect",t)}).on("reconnect",function(){n.trigger("reconnect")})}return r(t,[{key:"sendOperation",value:function(t,e,n){this.socket.emit("operation",t,e,n)}},{key:"sendSelection",value:function(t){this.socket.emit("selection",t)}},{key:"registerCallbacks",value:function(t){this.callbacks=t}},{key:"trigger",value:function(t){var e=this.callbacks&&this.callbacks[t];if(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];e.apply(this,r)}}}]),t}()},{}],4:[function(t,e,n){"use strict";e.exports={AttributeConstants:{BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt"},SentinelConstants:{LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:""}}},{}],5:[function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=t("./Utils.js"),s=t("./Client.js"),a=s.Client,u=s.AwaitingWithBuffer,l=t("./UndoManager.js"),h=t("./TextOperation.js"),c=t("./Selection.js"),f=c.Range,d=c.Selection,p=t("./WrappedOperation.js"),v=function(){function t(e,n){r(this,t),this.selectionBefore=e,this.selectionAfter=n}return i(t,[{key:"invert",value:function(){return new t(this.selectionAfter,this.selectionBefore)}},{key:"compose",value:function(e){return new t(this.selectionBefore,e.selectionAfter)}},{key:"transform",value:function(e){return new t(this.selectionBefore.transform(e),this.selectionAfter.transform(e))}}]),t}(),g=function(){function t(e,n,i,s){r(this,t),this.editorAdapter=e,this.id=n,this.name=i||n,this.setColor(i?o.hueFromName(i):Math.random()),this.selection=s||new d([new f(0,0)]),this.updateSelection(this.selection)}return i(t,[{key:"setColor",value:function(t){this.hue=t,this.color=o.hsl2hex(t,.75,.5),this.lightColor=o.hsl2hex(t,.5,.9)}},{key:"setName",value:function(t){this.name!==t&&(this.name=t),this.setColor(o.hueFromName(t))}},{key:"updateSelection",value:function(t){this.removeSelection(),this.selection=t,this.mark=this.editorAdapter.setOtherSelection(t,t.somethingSelected()?this.lightColor:this.color,this.id)}},{key:"removeSelection",value:function(){this.mark&&(this.mark.clear(),this.mark=null)}},{key:"remove",value:function(){this.removeSelection()}}]),t}();e.exports=function(t){function e(t,n,i){r(this,e);var s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t.revision,t.operations));return o.makeEventEmitter(e,["undoStatesChanged","clientsChanged"],s),s.serverAdapter=n,s.editorAdapter=i,s.undoManager=new l(50),s.clients={},s.serverAdapter.registerCallbacks({client_join:function(t){s.onClientJoin(t)},client_left:function(t){s.onClientLeft(t)},set_name:function(t,e){s.getClientObject(t).setName(e)},ack:function(){s.serverAck()},operation:function(t){s.applyServer(h.fromJSON(t))},selection:function(t,e){e?s.getClientObject(t).updateSelection(s.transformSelection(d.fromJSON(e))):s.getClientObject(t).removeSelection()},disconnect:function(t){},reconnect:function(){s.serverReconnect()}}),s.editorAdapter.registerCallbacks({change:s.onChange.bind(s),selectionChange:s.onSelectionChange.bind(s),focus:s.onFocus.bind(s),blur:s.onBlur.bind(s)}),s.editorAdapter.registerUndo(s.undo.bind(s)),s.editorAdapter.registerRedo(s.redo.bind(s)),s.initClientContent(),s.initOtherClients(t.clients),s._simultaneousFlag=!1,s}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,a),i(e,[{key:"initOtherClients",value:function(t){var e=this,n=Object.keys(t);if(n.length){for(var r=0;r<n.length;r++){var i=n[r],o=t[i];this.clients[i]=new g(this.editorAdapter,o.id,o.name,d.fromJSON(o.selection))}setTimeout(function(){e.trigger("clientsChanged",e.parseClientsInfo())})}}},{key:"sendOperation",value:function(t,e){this.serverAdapter.sendOperation(t,e.toJSON(),this.selection)}},{key:"applyOperation",value:function(t){this.editorAdapter.applyOperation(t),this.updateSelection(),this.undoManager.transform(new p(t,null))}},{key:"onClientJoin",value:function(t){var e=t.id;console.log("User join: ",e),this.clients[e]=new g(this.editorAdapter,e,t.name,d.fromJSON(t.selection)),this.trigger("clientsChanged",this.parseClientsInfo())}},{key:"onClientLeft",value:function(t){console.log("User left: "+t);var e=this.clients[t];e&&(e.remove(),delete this.clients[t],this.trigger("clientsChanged",this.parseClientsInfo()))}},{key:"parseClientsInfo",value:function(){return Object.values(this.clients).map(function(t){return{id:t.id,name:t.name,color:t.color,lightColor:t.lightColor}})}},{key:"getClientObject",value:function(t){var e=this.clients[t];return e||(this.clients[t]=new g(this.editorAdapter,t),this.clients[t])}},{key:"onChange",value:function(t,e){console.log("--onChange--: ",t);var n=this.selection;this.updateSelection();var r=this.undoManager.undoStack.length>0&&e.shouldBeComposedWithInverted(function(t){return t[t.length-1]}(this.undoManager.undoStack).wrapped),i=new v(this.selection,n);this.undoManager.add(new p(e,i),r||this._simultaneousFlag);var o=this.editorAdapter.rtcm.codeMirror.doc.listSelections().length;t.baseLength===t.targetLength&&o>=2?this._simultaneousFlag=!0:this._simultaneousFlag=!1,this.applyClient(t),this.trigger("undoStatesChanged",{canUndo:this.undoManager.canUndo(),canRedo:this.undoManager.canRedo()})}},{key:"updateSelection",value:function(){this.selection=this.editorAdapter.getSelection()}},{key:"onSelectionChange",value:function(){var t=this.selection;this.updateSelection(),t&&this.selection.equals(t)||this.sendSelection(this.selection)}},{key:"sendSelection",value:function(t){this.state instanceof u||this.serverAdapter.sendSelection(t)}},{key:"onFocus",value:function(){this.onSelectionChange()}},{key:"onBlur",value:function(){this.selection=null,this.sendSelection(null)}},{key:"undo",value:function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})}},{key:"redo",value:function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})}},{key:"applyUnredo",value:function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.selection=t.meta.selectionAfter,this.selection&&this.editorAdapter.setSelection(this.selection),this.applyClient(t.wrapped),this.trigger("undoStatesChanged",{canUndo:this.undoManager.canUndo(),canRedo:this.undoManager.canRedo()})}}]),e}()},{"./Client.js":2,"./Selection.js":9,"./TextOperation.js":12,"./UndoManager.js":13,"./Utils.js":14,"./WrappedOperation.js":15}],6:[function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=t("./Constants.js").AttributeConstants,a=t("./Utils.js"),u=s.ENTITY_SENTINEL,l=u+"_",h=function(){function t(e,n){r(this,t),this.type=e,this.info=n}return o(t,[{key:"toAttributes",value:function(){var t={};t[u]=this.type;for(var e in t)t[l+e]=this.info[e];return t}}],[{key:"fromAttributes",value:function(e){var n=e[u],r={};for(var i in e)0===i.indexOf(l)&&(r[i.substr(l.length)]=e[i]);return new t(n,r)}}]),t}(),c=function(){function t(){r(this,t),this.entities={},this.registImage()}return o(t,[{key:"registImage",value:function(){var t=["src","alt","width","height","style","class"];this.register("img",{render:function(e,n){a.assert(e.src,"image entity should have 'src'!");for(var r="<img ",i=0;i<t.length;i++){var o=t[i];o in e&&(r+=" "+o+'="'+e[o]+'"')}return r+=">"},fromElement:function(e){for(var n={},r=0;r<t.length;r++){var i=t[r];e.hasAttribute(i)&&(n[i]=e.getAttribute(i))}return n}})}},{key:"register",value:function(t,e){a.assert(e.render,"Entity options should include a 'render' function!"),a.assert(e.fromElement,"Entity options should include a 'fromElement' function!"),this.entities[t]=e}},{key:"renderToElement",value:function(t,e){return this.tryRenderToElement_(t,"render",e)}},{key:"exportToElement",value:function(t){var e=this.tryRenderToElement_(t,"export")||this.tryRenderToElement_(t,"getHtml")||this.tryRenderToElement_(t,"render");return e.setAttribute("data-entity",t.type),e}},{key:"updateElement",value:function(t,e){var n=t.type,r=t.info;this.entities[n]&&void 0!==this.entities[n].update&&this.entities[n].update(r,e)}},{key:"fromElement",value:function(t){var e=t.getAttribute("data-entity");if(e||(e=t.nodeName.toLowerCase()),e&&this.entities[e]){var n=this.entities[e].fromElement(t);return new h(e,n)}}},{key:"tryRenderToElement_",value:function(t,e,n){var r=t.type,o=t.info;if(this.entities[r]&&this.entities[r][e]){var s=this.entities[r][e](o,n,document);if(s){if("string"==typeof s){var u=document.createElement("div");return u.innerHTML=s,u.childNodes[0]}if("object"===(void 0===s?"undefined":i(s)))return a.assert(void 0!==s.nodeType,"Error rendering "+r+" entity.  render() function must return an html string or a DOM element."),s}}}},{key:"entitySupportsUpdate",value:function(t){return this.entities[t]&&this.entities[t].update}}]),t}();e.exports={Entity:h,EntityManager:c}},{"./Constants.js":4,"./Utils.js":14}],7:[function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t){if(0===t.length)return 0;for(var e=0,n=0;n<t.length;n++)e+=t[n].length;return e+t.length-1}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=t("./Utils.js"),u=t("./EntityManager.js"),l=u.Entity,h=u.EntityManager,c=t("./Constants.js"),f=c.AttributeConstants,d=c.SentinelConstants,p=t("./AnnotationList.js"),v=p.Span,g=p.AnnotationList,y=function(){function t(e){r(this,t),this.attributes=e||{}}return s(t,[{key:"equals",value:function(e){if(!(e instanceof t))return!1;var n=Object.getOwnPropertyNames(this.attributes),r=Object.getOwnPropertyNames(e.attributes);if(n.length!==r.length)return!1;var i=!0,o=!1,s=void 0;try{for(var a,u=n[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var l=a.value;if(this.attributes[l]!==e.attributes[l])return!1}}catch(t){o=!0,s=t}finally{try{!i&&u.return&&u.return()}finally{if(o)throw s}}return!0}}]),t}(),m=d.LINE_SENTINEL_CHARACTER,b=d.ENTITY_SENTINEL_CHARACTER,k={c:"color",bc:"background-color",fs:"font-size",li:function(t){return"padding-left: "+40*t+"px"}},w={};e.exports=function(){function t(e){r(this,t),this.codeMirror=e,this.entityManager=new h,this.currentAttributes_=null,this.annotationList_=new g(this.onAnnotationsChanged_.bind(this)),this.initAnnotationList_(),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_.bind(this)),parseInt(window.CodeMirror.version)>4?this.codeMirror.on("changes",this.onCodeMirrorChange_.bind(this)):this.codeMirror.on("change",this.onCodeMirrorChange_.bind(this)),this.codeMirror.on("cursorActivity",this.onCursorActivity_.bind(this)),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[],this.realtimeTextAttrs_={},a.makeEventEmitter(t,["change","attributesChange","newLine","realtimeTextAttrsChanged"],this)}return s(t,[{key:"detach",value:function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_.bind(this)),parseInt(window.CodeMirror.version)>4?this.codeMirror.off("changes",this.onCodeMirrorChange_.bind(this)):this.codeMirror.off("change",this.onCodeMirrorChange_.bind(this)),this.codeMirror.off("cursorActivity",this.onCursorActivity_.bind(this)),this.clearAnnotations_()}},{key:"end",value:function(){var t=this.codeMirror.lineCount()-1,e=this.codeMirror.getLine(t).length;return this.codeMirror.indexFromPos({line:t,ch:e})}},{key:"getRange",value:function(t,e){var n=this.codeMirror.posFromIndex(t),r=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(n,r)}},{key:"getAttributeSpans",value:function(t,e){for(var n=[],r=this.annotationList_.getAnnotatedSpansForSpan(new v(t,e-t)),i=0;i<r.length;i++)n.push({length:r[i].length,attributes:r[i].annotation.attributes});return n}},{key:"setAttribute",value:function(t,e){var n=this.codeMirror;if(this.emptySelection_()){var r=this.getCurrentAttributes_();!1===e?delete r[t]:r[t]=e,this.currentAttributes_=r}else{var i=n.doc.listSelections(),o=!0,s=!1,a=void 0;try{for(var u,l=i[Symbol.iterator]();!(o=(u=l.next()).done);o=!0){var h=u.value,c=n.indexFromPos(h.anchor),f=n.indexFromPos(h.head),d=Math.min(c,f),p=Math.max(c,f);this.updateTextAttributes(d,p,function(n){!1===e?delete n[t]:n[t]=e})}}catch(t){s=!0,a=t}finally{try{!o&&l.return&&l.return()}finally{if(s)throw a}}this.updateCurrentAttributes_()}}},{key:"toggleAttribute",value:function(t,e){var n=e||!0;if(this.emptySelection_()){var r=this.getCurrentAttributes_();r[t]===n?delete r[t]:r[t]=n,this.currentAttributes_=r}else{var i=this.getCurrentAttributes_()[t]!==n&&n;this.setAttribute(t,i)}}},{key:"updateTextAttributes",value:function(t,e,n,r,i){var o=[],s=t,u=this;this.annotationList_.updateSpan(new v(t,e-t),function(t,e){var l={};for(var h in t.attributes)l[h]=t.attributes[h];l[f.LINE_SENTINEL]&&!i||n(l);var c={},d={};return u.computeChangedAttributes_(t.attributes,l,c,d),a.emptyAttributes(c)||o.push({start:s,end:s+e,attributes:c,attributesInverse:d,origin:r}),s+=e,new y(l)}),o.length>0&&(this.trigger("attributesChange",this,o),setTimeout(this._textAttrsUpdate.bind(this)))}},{key:"computeChangedAttributes_",value:function(t,e,n,r){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(n[i]=e[i],r[i]=t[i]):(n[i]=e[i],r[i]=!1):(n[i]=!1,r[i]=t[i])}},{key:"newline",value:function(){var t=this.codeMirror,e=this;if(this.emptySelection_()){var n=t.getCursor("head").line,r=this.getLineAttributes_(n),i=r[f.LIST_TYPE];i&&1===t.getLine(n).length?this.updateLineAttributes(n,n,function(t){delete t[f.LIST_TYPE],delete t[f.LINE_INDENT]}):(t.replaceSelection("\n","end","+input"),this.updateLineAttributes(n+1,n+1,function(t){for(var o in r)t[o]=r[o];"tc"===i&&(t[f.LIST_TYPE]="t"),e.trigger("newLine",{line:n+1,attr:t})}))}else t.replaceSelection("\n","end","+input")}},{key:"getLineAttributes_",value:function(t){var e={},n=this.codeMirror.getLine(t);if(n.length>0&&n[0]===m){var r=this.codeMirror.indexFromPos({line:t,ch:0}),i=this.annotationList_.getAnnotatedSpansForSpan(new v(r,1));a.assert(1===i.length);for(var o in i[0].annotation.attributes)e[o]=i[0].annotation.attributes[o]}return e}},{key:"updateLineAttributes",value:function(t,e,n){for(var r=t;r<=e;r++){var i=this.codeMirror.getLine(r),o=this.codeMirror.indexFromPos({line:r,ch:0});if(i[0]!==m){var s={};s[f.LINE_SENTINEL]=!0,n(s),this.insertText(o,m,s)}else this.updateTextAttributes(o,o+1,n,null,!0)}}},{key:"insertText",value:function(t,e,n,r){var i=this.codeMirror,o=i.getCursor(),s="RTCMADAPTER"===r&&!i.somethingSelected()&&t===i.indexFromPos(o);this.replaceText(t,null,e,n,r),s&&i.setCursor(o)}},{key:"replaceText",value:function(t,e,n,r,i){this.changeId_++;var o="rtcm-"+this.changeId_;this.outstandingChanges_[o]={origOrigin:i,attributes:r};var s=this.codeMirror,a=s.posFromIndex(t),u="number"==typeof e?s.posFromIndex(e):null;s.replaceRange(n,a,u,o)}},{key:"removeText",value:function(t,e,n){var r=this.codeMirror;r.replaceRange("",r.posFromIndex(t),r.posFromIndex(e),n)}},{key:"deleteLeft",value:function(){var t=this.codeMirror,e=t.getCursor("head"),n=this.getLineAttributes_(e.line),r=n[f.LIST_TYPE],i=n[f.LINE_INDENT],o=this.emptySelection_()&&1===e.ch;o&&r?this.updateLineAttributes(e.line,e.line,function(t){delete t[f.LIST_TYPE],delete t[f.LINE_INDENT]}):o&&i&&i>0?this.unindent():t.deleteH(-1,"char")}},{key:"deleteRight",value:function(){var t=this.codeMirror,e=t.getCursor("head"),n=t.getLine(e.line),r=this.areLineSentinelCharacters_(n),i=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&r&&i[0]===m?(t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"),t.setCursor({line:e.line,ch:0})):t.deleteH(1,"char")}},{key:"indent",value:function(){this.updateLineAttributesForSelection(function(t){var e=t[f.LINE_INDENT],n=t[f.LIST_TYPE];e?t[f.LINE_INDENT]++:t[f.LINE_INDENT]=n?2:1})}},{key:"unindent",value:function(){this.updateLineAttributesForSelection(function(t){var e=t[f.LINE_INDENT];e&&e>1?t[f.LINE_INDENT]=e-1:(delete t[f.LIST_TYPE],delete t[f.LINE_INDENT])})}},{key:"initAnnotationList_",value:function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new v(0,t),new y)}},{key:"clearAnnotations_",value:function(){this.annotationList_.updateSpan(new v(0,this.end()),function(t,e){return new y({})})}},{key:"onCodeMirrorBeforeChange_",value:function(t,e){if("+input"===e.origin||"paste"===e.origin){for(var n=[],r=0;r<e.text.length;r++){var i=e.text[r];i=i.replace(new RegExp("["+m+b+"]","g"),""),n.push(i)}e.update(e.from,e.to,n)}}},{key:"onCodeMirrorChange_",value:function(t,e){if("object"===o(e.from)){for(var n=[];e;)n.push(e),e=e.next;e=n}for(var r=this.convertCoordinateSystemForChanges_(e),i=[],s=0;s<r.length;s++){var a=r[s],u=a.start,l=a.text,h=a.removed,c=a.origin;if(h.length>0){for(var f=this.annotationList_.getAnnotatedSpansForSpan(new v(u,h.length)),d=0,p=0;p<f.length;p++){var g=f[p];i.push({start:u,end:u+g.length,removedAttributes:g.annotation.attributes,removed:h.substr(d,g.length),attributes:{},text:"",origin:a.origin}),d+=g.length}this.annotationList_.removeSpan(new v(u,h.length))}if(l.length>0){var m;"+input"===a.origin||"paste"===a.origin||"*compose"===a.origin?m=this.currentAttributes_||{}:c in this.outstandingChanges_?(m=this.outstandingChanges_[c].attributes,c=this.outstandingChanges_[c].origOrigin,delete this.outstandingChanges_[c]):m={},this.annotationList_.insertAnnotatedSpan(new v(u,l.length),new y(m)),i.push({start:u,end:u,removedAttributes:{},removed:"",text:l,attributes:m,origin:c})}}this.markLineSentinelCharactersForChanges_(e),i.length>0&&(this.trigger("change",this,i),setTimeout(this._textAttrsUpdate.bind(this)))}},{key:"onCursorActivity_",value:function(){var t=this;setTimeout(function(){t.updateCurrentAttributes_(),t._textAttrsUpdate()},1)}},{key:"_textAttrsUpdate",value:function(){var t={};a.shallowClone(this.getCurrentAttributes_(),t),a.shallowClone(this.getCurrentLineAttributes_(),t),a.shallowEqual(this.realtimeTextAttrs_,t)||(this.realtimeTextAttrs_=t,this.trigger("realtimeTextAttrsChanged",this.realtimeTextAttrs_))}},{key:"onAnnotationsChanged_",value:function(t,e){var n,r={};this.tryToUpdateEntitiesInPlace(t,e);for(var i=0;i<t.length;i++){var o=t[i].annotation.attributes;f.LINE_SENTINEL in o&&(r[this.codeMirror.posFromIndex(t[i].pos).line]=!0),(n=t[i].getAttachedObject())&&n.clear()}for(i=0;i<e.length;i++){var s=e[i].annotation,a=f.LINE_SENTINEL in s.attributes,u=f.ENTITY_SENTINEL in s.attributes,l=this.codeMirror.posFromIndex(e[i].pos);if(a)r[l.line]=!0;else if(u)this.markEntity_(e[i]);else{var h=this.getClassNameForAttributes_(s.attributes);if(""!==h){var c=this.codeMirror.posFromIndex(e[i].pos+e[i].length);n=this.codeMirror.markText(l,c,{className:h}),e[i].attachObject(n)}}}for(var d in r)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(d))),this.queueLineMarking_()}},{key:"getClassNameForAttributes_",value:function(t){var e="";for(var n in t){var r=t[n];if(n===f.LINE_SENTINEL)a.assert(!0===r,"LINE_SENTINEL attribute should be true if it exists.");else{var i="rtcm-"+n;if(!0!==r){n===f.FONT_SIZE&&"string"!=typeof r&&(r+="px");var o=r.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");if(i+="-"+o,k[n]&&(w[n]||(w[n]={}),!w[n][o])){w[n][o]=!0;var s=k[n],u="function"==typeof s?s(r):s+": "+r,l=n===f.LINE_INDENT?"pre."+i:"."+i;a.addStyleWithCSS(l+" { "+u+" }")}}e=e+" "+i}}return e}},{key:"queueLineMarking_",value:function(){if(null==this.lineMarkTimeout_){var t=this;this.lineMarkTimeout_=setTimeout(function(){t.lineMarkTimeout_=null;for(var e=[],n=0;n<t.dirtyLines_.length;n++){var r=t.codeMirror.getLineNumber(t.dirtyLines_[n]);e.push(Number(r))}t.dirtyLines_=[],e.sort(function(t,e){return t-e});var i=-1;for(n=0;n<e.length;n++){var o=e[n];o>i&&(i=t.markLineSentinelCharactersForChangedLines_(o,o))}},0)}}},{key:"getCurrentAttributes_",value:function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_}},{key:"updateCurrentAttributes_",value:function(){var t=this.codeMirror,e=t.indexFromPos(t.getCursor("anchor")),n=t.indexFromPos(t.getCursor("head")),r=n;if(e>n){for(;r<this.end();){var i=this.getRange(r,r+1);if("\n"!==i&&i!==m)break;r++}r<this.end()&&r++}else for(;r>0&&("\n"===(i=this.getRange(r-1,r))||i===m);)r--;var o=this.annotationList_.getAnnotatedSpansForPos(r);this.currentAttributes_={};var s={};o.length>0&&!(f.LINE_SENTINEL in o[0].annotation.attributes)?s=o[0].annotation.attributes:o.length>1&&(a.assert(!(f.LINE_SENTINEL in o[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),s=o[1].annotation.attributes);for(var u in s)"l"!==u&&"lt"!==u&&"li"!==u&&0!==u.indexOf(f.ENTITY_SENTINEL)&&(this.currentAttributes_[u]=s[u])}},{key:"convertCoordinateSystemForChanges_",value:function(t){function e(t,e){return function(n){return a.posLe(n,e.from)?t(n):a.posLe(e.to,n)?t({line:n.line+e.text.length-1-(e.to.line-e.from.line),ch:e.to.line<n.line?n.ch:e.text.length<=1?n.ch-(e.to.ch-e.from.ch)+i(e.text):n.ch-e.to.ch+function(t){return t[t.length-1]}(e.text).length})+i(e.removed)-i(e.text):e.from.line===n.line?t(e.from)+n.ch-e.from.ch:t(e.from)+i(e.removed.slice(0,n.line-e.from.line))+1+n.ch}}for(var n=this,r=function(t){return n.codeMirror.indexFromPos(t)},o=[],s=t.length-1;s>=0;s--){var u=t[s],l=(r=e(r,u))(u.from),h=u.removed.join("\n"),c=u.text.join("\n");o.unshift({start:l,end:l+h.length,removed:h,text:c,origin:u.origin})}return o}},{key:"markLineSentinelCharactersForChanges_",value:function(t){for(var e=Number.MAX_VALUE,n=-1,r=0;r<t.length;r++){var i=t[r],o=i.from.line;(i.removed.length>1||i.removed[0].indexOf(m)>=0)&&(e=Math.min(e,o),n=Math.max(n,o)),i.text.length>1?(e=Math.min(e,o),n=Math.max(n,o+i.text.length-1)):i.text[0].indexOf(m)>=0&&(e=Math.min(e,o),n=Math.max(n,o))}n=Math.min(n,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(e,n)}},{key:"markLineSentinelCharactersForChangedLines_",value:function(t,e){if(t<Number.MAX_VALUE)for(;t>0&&this.lineIsListItemOrIndented_(t-1);)t--;if(e>-1)for(var n=this.codeMirror.lineCount();e+1<n&&this.lineIsListItemOrIndented_(e+1);)e++;for(var r=[],i=this.codeMirror,o=t;o<=e;o++){var s=i.getLine(o),a=i.getLineHandle(o);if(i.removeLineClass(a,"text",".*"),s.length>0)for(var u=s.indexOf(m);u>=0;){for(var l=u;u<s.length&&s[u]===m;){for(var h=i.findMarksAt({line:o,ch:u}),c=0;c<h.length;c++)h[c].isForLineSentinel&&h[c].clear();u++}this.markLineSentinelCharacters_(o,l,u,r),u=s.indexOf(m,u)}else r=[]}return e}},{key:"lineIsListItemOrIndented_",value:function(t){var e=this.getLineAttributes_(t);return!1!==(e[f.LIST_TYPE]||!1)||0!==(e[f.LINE_INDENT]||0)}},{key:"markLineSentinelCharacters_",value:function(t,e,n,r){var i=this.codeMirror,o=null,s=null,a=function(){var t=s.find();return t?t.from.line:null};if(0===e){var u=this.getLineAttributes_(t),l=u[f.LIST_TYPE],h=u[f.LINE_INDENT]||0;for(l&&0===h&&(h=1);h>=r.length;)r.push(1);"o"===l?(o=this.makeOrderedListElement_(r[h]),r[h]++):"u"===l?(o=this.makeUnorderedListElement_(),r[h]=1):"t"===l?(o=this.makeTodoListElement_(!1,a),r[h]=1):"tc"===l&&(o=this.makeTodoListElement_(!0,a),r[h]=1);var c=this.getClassNameForAttributes_(u);""!==c&&this.codeMirror.addLineClass(t,"text",c),r=r.slice(0,h+1)}var d={inclusiveLeft:!0,collapsed:!0};o&&(d.replacedWith=o),(s=i.markText({line:t,ch:e},{line:t,ch:n},d)).isForLineSentinel=!0}},{key:"makeOrderedListElement_",value:function(t){return a.elt("div",t+".",{class:"rtcm-list-left"})}},{key:"makeUnorderedListElement_",value:function(){return a.elt("div","•",{class:"rtcm-list-left"})}},{key:"makeTodoListElement_",value:function(t,e){var n=this,r={type:"checkbox",class:"rtcm-todo-left"};t&&(r.checked=!0);var i=a.elt("input",!1,r);return a.on(i,"click",a.stopEventAnd(function(t){n.codeMirror.setCursor({line:e(),ch:1}),n.toggleTodo(!0)})),i}},{key:"toggleTodo",value:function(t){var e,n=f.LIST_TYPE,r=this.getCurrentLineAttributes_();n in r&&("t"===r[n]||"tc"===r[n])?"t"===r[n]?e=!!t&&"tc":"tc"===r[n]&&(e=!!t&&"t"):e="t",this.setLineAttribute(n,e)}},{key:"getCurrentLineAttributes_",value:function(){var t=this.codeMirror,e=t.getCursor("anchor"),n=t.getCursor("head"),r=n.line;return 0===n.ch&&e.line<n.line&&r--,this.getLineAttributes_(r)}},{key:"toggleLineAttribute",value:function(t,e){var n,r=this.getCurrentLineAttributes_();n=!(t in r&&r[t]===e)&&e,this.setLineAttribute(t,n)}},{key:"setLineAttribute",value:function(t,e){this.updateLineAttributesForSelection(function(n){!1===e?delete n[t]:n[t]=e})}},{key:"updateLineAttributesForSelection",value:function(t){var e=this.codeMirror,n=e.getCursor("start"),r=e.getCursor("end"),i=n.line,o=r.line,s=e.getLine(o),a=this.areLineSentinelCharacters_(s.substr(0,r.ch));o>i&&a&&o--,this.updateLineAttributes(i,o,t)}},{key:"areLineSentinelCharacters_",value:function(t){for(var e=0;e<t.length;e++)if(t[e]!==m)return!1;return!0}},{key:"emptySelection_",value:function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch}},{key:"tryToUpdateEntitiesInPlace",value:function(t,e){for(var n=t.length;n--;)for(var r=t[n],i=e.length;i--;){var o=e[i];if(r.pos===o.pos&&r.length===o.length&&r.annotation.attributes.ent&&r.annotation.attributes.ent===o.annotation.attributes.ent){var s=o.annotation.attributes.ent;if(this.entityManager.entitySupportsUpdate(s)){t.splice(n,1),e.splice(i,1);var a=r.getAttachedObject();a.update(o.annotation.attributes),o.attachObject(a)}}}}},{key:"markEntity_",value:function(t){for(var e=t.annotation.attributes,n=l.fromAttributes(e),r=this.codeMirror,i=this,o=[],s=0;s<t.length;s++){var a=r.posFromIndex(t.pos+s),u=r.posFromIndex(t.pos+s+1),h={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},c=this.createEntityHandle_(n,t.pos),f=this.entityManager.renderToElement(n,c);f&&(h.replacedWith=f);var d=r.markText(a,u,h);o.push(d),c.setMarker(d)}t.attachObject({clear:function(){for(var t=0;t<o.length;t++)o[t].clear()},update:function(t){for(var e=l.fromAttributes(t),n=0;n<o.length;n++)i.entityManager.updateElement(e,o[n].replacedWith)}}),this.queueRefresh_()}},{key:"queueRefresh_",value:function(){var t=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){t.codeMirror.refresh(),t.refreshTimer_=null},0))}},{key:"createEntityHandle_",value:function(t,e){function n(){if(r){var t=r.find();return t?i.codeMirror.indexFromPos(t.from):null}return e}var r=null,i=this;return{find:n,remove:function(){var t=n();null!=t&&(i.codeMirror.focus(),i.removeText(t,t+1))},replace:function(e){var r=f.ENTITY_SENTINEL,o=r+"_",s=n();i.updateTextAttributes(s,s+1,function(n){for(var i in n)delete n[i];n[r]=t.type;for(var s in e)n[o+s]=e[s]})},setMarker:function(t){r=t}}}}]),t}()},{"./AnnotationList.js":1,"./Constants.js":4,"./EntityManager.js":6,"./Utils.js":14}],8:[function(t,e,n){"use strict";function r(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=t("./Utils.js"),s=t("./Selection.js"),a=s.Range,u=s.Selection,l=t("./TextOperation.js"),h=t("./WrappedOperation.js"),c=function(){var t,e={};return function(n){if(!e[n]){if(e[n]=!0,!t){var r=document.createElement("style");(window.SharedPenRoot||document.documentElement.getElementsByTagName("head")[0]).appendChild(r),t=r.sheet}t.insertRule(n,(t.cssRules||t.rules).length)}}}();e.exports=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.rtcm=e,this.cm=e.codeMirror,this.rtcm.on("change",this.onChange,this),this.rtcm.on("attributesChange",this.onAttributesChange,this),this.cm.on("cursorActivity",this.onCursorActivity.bind(this)),this.cm.on("focus",this.onFocus.bind(this)),this.cm.on("blur",this.onBlur.bind(this))}return i(t,[{key:"detach",value:function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity.bind(this)),this.cm.off("focus",this.onFocus.bind(this)),this.cm.off("blur",this.onBlur.bind(this))}},{key:"onChange",value:function(e,n){if("RTCMADAPTER"!==n[0].origin){var r=t.operationFromCodeMirrorChanges(n,this.cm);this.trigger("change",r[0],r[1])}}},{key:"onAttributesChange",value:function(e,n){if("RTCMADAPTER"!==n[0].origin){var r=t.operationFromAttributesChanges(n,this.cm);this.trigger("change",r[0],r[1])}}},{key:"onCursorActivity",value:function(){this.trigger("selectionChange")}},{key:"onFocus",value:function(){this.trigger("focus")}},{key:"onBlur",value:function(){this.cm.somethingSelected()||this.trigger("blur")}},{key:"trigger",value:function(t){var e=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[t];n&&n.apply(this,e)}},{key:"registerCallbacks",value:function(t){this.callbacks=t}},{key:"registerUndo",value:function(t){this.cm.undo=t}},{key:"registerRedo",value:function(t){this.cm.redo=t}},{key:"getSelection",value:function(){for(var t=this.cm,e=t.listSelections(),n=[],r=0;r<e.length;r++)n[r]=new a(t.indexFromPos(e[r].anchor),t.indexFromPos(e[r].head));return new u(n)}},{key:"setSelection",value:function(t){for(var e=[],n=0;n<t.ranges.length;n++){var r=t.ranges[n];e[n]={anchor:this.cm.posFromIndex(r.anchor),head:this.cm.posFromIndex(r.head)}}this.cm.setSelections(e)}},{key:"applyOperation",value:function(t){t.ops.length>10&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var e=t.ops,n=0,r=0,i=e.length;r<i;r++){var s=e[r];s.isRetain()?(o.emptyAttributes(s.attributes)||this.rtcm.updateTextAttributes(n,n+s.chars,function(t){for(var e in s.attributes)!1===s.attributes[e]?delete t[e]:t[e]=s.attributes[e]},"RTCMADAPTER",!0),n+=s.chars):s.isInsert()?(this.rtcm.insertText(n,s.text,s.attributes,"RTCMADAPTER"),n+=s.text.length):s.isDelete()&&this.rtcm.removeText(n,n+s.chars,"RTCMADAPTER")}t.ops.length>10&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())}},{key:"invertOperation",value:function(t){for(var e,n,r=0,i=this.rtcm.codeMirror,s=new l,a=0;a<t.wrapped.ops.length;a++){var u=t.wrapped.ops[a];if(u.isRetain())if(o.emptyAttributes(u.attributes))s.retain(u.chars),r+=u.chars;else for(e=this.rtcm.getAttributeSpans(r,r+u.chars),n=0;n<e.length;n++){var c={};for(var f in u.attributes){var d=u.attributes[f],p=e[n].attributes[f];!1===d?p&&(c[f]=p):d!==p&&(c[f]=p||!1)}s.retain(e[n].length,c),r+=e[n].length}else if(u.isInsert())s.delete(u.text.length);else if(u.isDelete()){var v=i.getRange(i.posFromIndex(r),i.posFromIndex(r+u.chars));e=this.rtcm.getAttributeSpans(r,r+u.chars);var g=0;for(n=0;n<e.length;n++)s.insert(v.substr(g,e[n].length),e[n].attributes),g+=e[n].length;r+=u.chars}}return new h(s,t.meta.invert())}},{key:"setOtherSelection",value:function(t,e,n){for(var r=[],i=0;i<t.ranges.length;i++){var o=t.ranges[i];o.isEmpty()?r[i]=this.setOtherCursor(o.head,e,n):r[i]=this.setOtherSelectionRange(o,e,n)}return{clear:function(){for(var t=0;t<r.length;t++)r[t].clear()}}}},{key:"setOtherCursor",value:function(t,e,n){var r=this.cm.posFromIndex(t),i=this.cm.cursorCoords(r),o=document.createElement("span");return o.className="other-client",o.style.display="inline",o.style.padding="0",o.style.marginLeft=o.style.marginRight="-1px",o.style.borderLeftWidth="2px",o.style.borderLeftStyle="solid",o.style.borderLeftColor=e,o.style.height=i.bottom-i.top+"px",o.style.transform="translateY(2px)",o.style.zIndex=0,o.setAttribute("data-clientid",n),this.cm.setBookmark(r,{widget:o,insertLeft:!0})}},{key:"setOtherSelectionRange",value:function(t,e,n){var r=/^#([0-9a-fA-F]{6})$/.exec(e);if(!r)throw new Error("only six-digit hex colors are allowed.");var i="selection-"+r[1];c("."+i+" { background: "+e+"; }");var s=this.cm.posFromIndex(t.anchor),a=this.cm.posFromIndex(t.head);return this.cm.markText(function(t,e){return o.posLe(t,e)?t:e}(s,a),function(t,e){return o.posLe(t,e)?e:t}(s,a),{className:i})}}],[{key:"operationFromCodeMirrorChanges",value:function(t,e){for(var n=r(e),i=(new l).retain(n),o=(new l).retain(n),s=t.length-1;s>=0;s--){var a=t[s],u=a.start,h=n-u-a.text.length;i=(new l).retain(u).delete(a.removed.length).insert(a.text,a.attributes).retain(h).compose(i),o=o.compose((new l).retain(u).delete(a.text.length).insert(a.removed,a.removedAttributes).retain(h)),n+=a.removed.length-a.text.length}return[i,o]}},{key:"operationFromAttributesChanges",value:function(t,e){for(var n=r(e),i=new l,s=new l,a=0,u=0;u<t.length;u++){var h=t[u],c=h.start-a;o.assert(c>=0),i.retain(c),s.retain(c);var f=h.end-h.start;i.retain(f,h.attributes),s.retain(f,h.attributesInverse),a=h.start+f}return i.retain(n-a),s.retain(n-a),[i,s]}}]),t}()},{"./Selection.js":9,"./TextOperation.js":12,"./Utils.js":14,"./WrappedOperation.js":15}],9:[function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=function(){function t(e,n){r(this,t),this.anchor=e,this.head=n}return i(t,[{key:"equals",value:function(t){return this.anchor===t.anchor&&this.head===t.head}},{key:"isEmpty",value:function(){return this.anchor===this.head}},{key:"transform",value:function(e){function n(t){for(var n=t,r=e.ops,i=0,o=e.ops.length;i<o&&(r[i].isRetain()?t-=r[i].chars:r[i].isInsert()?n+=r[i].text.length:(n-=Math.min(t,r[i].chars),t-=r[i].chars),!(t<0));i++);return n}var r=n(this.anchor);if(this.isEmpty())return new t(r,r);return new t(r,n(this.head))}}],[{key:"fromJSON",value:function(e){return new t(e.anchor,e.head)}}]),t}(),s=function(){function t(e){r(this,t),this.ranges=e||[]}return i(t,[{key:"equals",value:function(t){if(this.ranges.length!==t.ranges.length)return!1;for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].equals(t.ranges[e]))return!1;return!0}},{key:"somethingSelected",value:function(){return this.ranges.find(function(t){return!t.isEmpty()})}},{key:"compose",value:function(t){return t}},{key:"transform",value:function(e){return new t(this.ranges.map(function(t){return t.transform(e)}))}}],[{key:"createCursor",value:function(e){return new t([new o(e,e)])}},{key:"fromJSON",value:function(e){return new t((e.ranges||e).map(function(t){return o.fromJSON(t)}))}}]),t}();e.exports={Range:o,Selection:s}},{}],10:[function(t,e,n){"use strict";var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=t("./Utils.js"),o=t("./Constants.js").AttributeConstants,s=t("./RichTextCodeMirror.js"),a=t("./RichTextCodeMirrorAdapter.js"),u=t("./ClientSocketIOAdapter.js"),l=t("./EditorClient.js");e.exports=function(){function t(e,n){var r=this;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),!window.CodeMirror)throw new Error("Couldn't find CodeMirror. Did you forget to include codemirror.js?");if(!window.io)throw new Error("Couldn't find SocketIO. Did you forget to include socket.io.js?");if(e instanceof window.CodeMirror)this.cm=e;else{var o=e;"string"==typeof e&&(o=document.querySelector(e)),this.cm=window.CodeMirror.fromTextArea(o,{lineNumbers:!0,lineWrapping:!0})}i.makeEventEmitter(t,["ready","realtimeTextAttrsChanged","undoStatesChanged","clientsChanged"],this),this.rtcm=new s(this.cm),this.rtcmAdapter=new a(this.rtcm);var h=window.io(n);h.on("doc",function(t){r.socketIOAdapter=new u(h),r.client=new l(t,r.socketIOAdapter,r.rtcmAdapter),r.rtcm.on("realtimeTextAttrsChanged",r.trigger.bind(r,"realtimeTextAttrsChanged")),r.client.on("undoStatesChanged",r.trigger.bind(r,"undoStatesChanged")),r.client.on("clientsChanged",r.trigger.bind(r,"clientsChanged")),r.trigger("ready")}),window.CodeMirror.keyMap.sharedpen||this.initializeKeyMap_(),this.cm.setOption("keyMap","sharedpen")}return r(t,[{key:"initializeKeyMap_",value:function(){function t(t){return function(e){setTimeout(t,0)}}window.CodeMirror.keyMap.sharedpen={"Ctrl-B":t(this.bold.bind(this)),"Cmd-B":t(this.bold.bind(this)),"Ctrl-I":t(this.italic.bind(this)),"Cmd-I":t(this.italic.bind(this)),"Ctrl-U":t(this.underline.bind(this)),"Cmd-U":t(this.underline.bind(this)),"Ctrl-H":t(this.highlight.bind(this)),"Cmd-H":t(this.highlight.bind(this)),Enter:t(this.newline.bind(this)),Delete:t(this.deleteRight.bind(this)),Backspace:t(this.deleteLeft.bind(this)),Tab:t(this.indent.bind(this)),"Shift-Tab":t(this.unindent.bind(this)),fallthrough:["default"]}}},{key:"bold",value:function(){this.rtcm.toggleAttribute(o.BOLD),this.cm.focus()}},{key:"italic",value:function(){this.rtcm.toggleAttribute(o.ITALIC),this.cm.focus()}},{key:"underline",value:function(){this.rtcm.toggleAttribute(o.UNDERLINE),this.cm.focus()}},{key:"strike",value:function(){this.rtcm.toggleAttribute(o.STRIKE),this.cm.focus()}},{key:"fontSize",value:function(t){this.rtcm.setAttribute(o.FONT_SIZE,t),this.cm.focus()}},{key:"font",value:function(t){this.rtcm.setAttribute(o.FONT,t),this.cm.focus()}},{key:"color",value:function(t){this.rtcm.setAttribute(o.COLOR,t),this.cm.focus()}},{key:"highlight",value:function(t){this.rtcm.toggleAttribute(o.BACKGROUND_COLOR,t),this.cm.focus()}},{key:"align",value:function(t){if("left"!==t&&"center"!==t&&"right"!==t&&"justify"!==t)throw new Error('align() must be passed "left", "center", or "right".');this.rtcm.setLineAttribute(o.LINE_ALIGN,t),this.cm.focus()}},{key:"newline",value:function(){this.rtcm.newline()}},{key:"deleteLeft",value:function(){this.rtcm.deleteLeft()}},{key:"deleteRight",value:function(){this.rtcm.deleteRight()}},{key:"indent",value:function(){this.rtcm.indent(),this.cm.focus()}},{key:"unindent",value:function(){this.rtcm.unindent(),this.cm.focus()}},{key:"orderedList",value:function(){this.rtcm.toggleLineAttribute(o.LIST_TYPE,"o"),this.cm.focus()}},{key:"unorderedList",value:function(){this.rtcm.toggleLineAttribute(o.LIST_TYPE,"u"),this.cm.focus()}},{key:"todoList",value:function(){this.rtcm.toggleTodo(),this.cm.focus()}},{key:"undo",value:function(){this.client.undo()}},{key:"redo",value:function(){this.client.redo()}}]),t}()},{"./ClientSocketIOAdapter.js":3,"./Constants.js":4,"./EditorClient.js":5,"./RichTextCodeMirror.js":7,"./RichTextCodeMirrorAdapter.js":8,"./Utils.js":14}],11:[function(t,e,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=t("./Utils.js");e.exports=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.type=e,this.chars=null,this.text=null,this.attributes=null,"insert"===e?(this.text=arguments[1],o.assert("string"==typeof this.text),this.attributes=arguments[2]||{},o.assert("object"===r(this.attributes))):"delete"===e?(this.chars=arguments[1],o.assert("number"==typeof this.chars)):"retain"===e&&(this.chars=arguments[1],o.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},o.assert("object"===r(this.attributes)))}return i(t,[{key:"isInsert",value:function(){return"insert"===this.type}},{key:"isDelete",value:function(){return"delete"===this.type}},{key:"isRetain",value:function(){return"retain"===this.type}},{key:"equals",value:function(t){return this.type===t.type||this.chars===t.chars||this.text===t.text||this.attributesEqual(t.attributes)}},{key:"attributesEqual",value:function(t){var e=Object.getOwnPropertyNames(this.attributes),n=Object.getOwnPropertyNames(t);if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++){var i=e[r];if(this.attributes[i]!==t[i])return!1}return!0}},{key:"hasEmptyAttributes",value:function(){for(var t in this.attributes)if(this.attributes.hasOwnProperty(t))return!1;return!0}}]),t}()},{"./Utils.js":14}],12:[function(t,e,n){"use strict";function r(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function i(t){return t.ops[0].isRetain()?t.ops[0].chars:0}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=t("./Utils.js"),u=t("./TextAction.js");e.exports=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.ops=[],this.baseLength=0,this.targetLength=0}return s(t,[{key:"equals",value:function(t){if(this.baseLength!==t.baseLength||this.targetLength!==t.targetLength||this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0}},{key:"retain",value:function(t,e){if("number"!=typeof t||t<0)throw new Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,e=e||{};var n=this.ops.length>0?this.ops[this.ops.length-1]:null;return n&&n.isRetain()&&n.attributesEqual(e)?n.chars+=t:this.ops.push(new u("retain",t,e)),this}},{key:"insert",value:function(t,e){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;e=e||{},this.targetLength+=t.length;var n=this.ops.length>0?this.ops[this.ops.length-1]:null,r=this.ops.length>1?this.ops[this.ops.length-2]:null;return n&&n.isInsert()&&n.attributesEqual(e)?n.text+=t:n&&n.isDelete()?r&&r.isInsert()&&r.attributesEqual(e)?r.text+=t:(this.ops[this.ops.length-1]=new u("insert",t,e),this.ops.push(n)):this.ops.push(new u("insert",t,e)),this}},{key:"delete",value:function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||t<0)throw new Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var e=this.ops.length>0?this.ops[this.ops.length-1]:null;return e&&e.isDelete()?e.chars+=t:this.ops.push(new u("delete",t)),this}},{key:"isNoop",value:function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()}},{key:"clone",value:function(){for(var e=new t,n=0;n<this.ops.length;n++)this.ops[n].isRetain()?e.retain(this.ops[n].chars,this.ops[n].attributes):this.ops[n].isInsert()?e.insert(this.ops[n].text,this.ops[n].attributes):e.delete(this.ops[n].chars);return e}},{key:"toJSON",value:function(){var t=[],e=!0,n=!1,r=void 0;try{for(var i,o=this.ops[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var s=i.value;s.hasEmptyAttributes()||t.push(s.attributes),s.isRetain()?t.push(s.chars):s.isInsert()?t.push(s.text):s.isDelete()&&t.push(-s.chars)}}catch(t){n=!0,r=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw r}}return t}},{key:"apply",value:function(t,e,n){if(e=e||[],n=n||[],t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var r,i,o=[],s=0,u=0,l=this.ops,h=0,c=l.length;h<c;h++){var f=l[h];if(f.isRetain()){if(u+f.chars>t.length)throw new Error("Operation can't retain more characters than are left in the string.");for(o[s++]=t.slice(u,u+f.chars),r=0;r<f.chars;r++){var d=e[u+r]||{},p={};for(i in d)p[i]=d[i],a.assert(!1!==p[i]);for(i in f.attributes)!1===f.attributes[i]?delete p[i]:p[i]=f.attributes[i],a.assert(!1!==p[i]);n.push(p)}u+=f.chars}else if(f.isInsert())for(o[s++]=f.text,r=0;r<f.text.length;r++){var v={};for(i in f.attributes)v[i]=f.attributes[i],a.assert(!1!==v[i]);n.push(v)}else u+=f.chars}if(u!==t.length)throw new Error("The operation didn't operate on the whole string.");var g=o.join("");return a.assert(g.length===n.length),g}},{key:"invert",value:function(e){for(var n=0,r=new t,i=this.ops,o=0,s=i.length;o<s;o++){var a=i[o];a.isRetain()?(r.retain(a.chars),n+=a.chars):a.isInsert()?r.delete(a.text.length):(r.insert(e.slice(n,n+a.chars)),n+=a.chars)}return r}},{key:"compose",value:function(e){function n(t,e,n){var r,i={};for(r in t)i[r]=t[r];for(r in e)n&&!1===e[r]?delete i[r]:i[r]=e[r];return i}if(this.targetLength!==e.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var r,i=new t,o=this.clone().ops,s=e.clone().ops,a=0,u=0,l=o[a++],h=s[u++];void 0!==l||void 0!==h;)if(l&&l.isDelete())i.delete(l.chars),l=o[a++];else if(h&&h.isInsert())i.insert(h.text,h.attributes),h=s[u++];else{if(void 0===l)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===h)throw new Error("Cannot compose operations: first operation is too long.");if(l.isRetain()&&h.isRetain())r=n(l.attributes,h.attributes),l.chars>h.chars?(i.retain(h.chars,r),l.chars-=h.chars,h=s[u++]):l.chars===h.chars?(i.retain(l.chars,r),l=o[a++],h=s[u++]):(i.retain(l.chars,r),h.chars-=l.chars,l=o[a++]);else if(l.isInsert()&&h.isDelete())l.text.length>h.chars?(l.text=l.text.slice(h.chars),h=s[u++]):l.text.length===h.chars?(l=o[a++],h=s[u++]):(h.chars-=l.text.length,l=o[a++]);else if(l.isInsert()&&h.isRetain())r=n(l.attributes,h.attributes,!0),l.text.length>h.chars?(i.insert(l.text.slice(0,h.chars),r),l.text=l.text.slice(h.chars),h=s[u++]):l.text.length===h.chars?(i.insert(l.text,r),l=o[a++],h=s[u++]):(i.insert(l.text,r),h.chars-=l.text.length,l=o[a++]);else{if(!l.isRetain()||!h.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(l)+", op2: "+JSON.stringify(h));l.chars>h.chars?(i.delete(h.chars),l.chars-=h.chars,h=s[u++]):l.chars===h.chars?(i.delete(h.chars),l=o[a++],h=s[u++]):(i.delete(l.chars),h.chars-=l.chars,l=o[a++])}}return i}},{key:"shouldBeComposedWith",value:function(t){if(this.isNoop()||t.isNoop())return!0;var e=i(this),n=i(t),o=r(this),s=r(t);return!(!o||!s)&&(o.isInsert()&&s.isInsert()?e+o.text.length===n:!(!o.isDelete()||!s.isDelete())&&(n+s.chars===e||e===n))}},{key:"shouldBeComposedWithInverted",value:function(t){if(this.isNoop()||t.isNoop())return!0;var e=i(this),n=i(t),o=r(this),s=r(t);return!(!o||!s)&&(o.isInsert()&&s.isInsert()?e+o.text.length===n||e===n:!(!o.isDelete()||!s.isDelete())&&n+s.chars===e)}},{key:"transform",value:function(e){return t.transform(this,e)}},{key:"toString",value:function(){}}],[{key:"fromJSON",value:function(e){for(var n=new t,r=0;r<e.length;r++){var i=e[r],s={};"object"===(void 0===i?"undefined":o(i))&&(s=i,i=e[++r]),"number"==typeof i?i>0?n.retain(i,s):n.delete(-i):(a.assert("string"==typeof i),n.insert(i,s))}return n}},{key:"transformAttributes",value:function(t,e){var n,r={},i={},o={};for(n in t)o[n]=!0;for(n in e)o[n]=!0;for(n in o){var s=t[n],u=e[n];a.assert(null!=s||null!=u),null==s?i[n]=u:null==u?r[n]=s:s===u||(r[n]=s)}return[r,i]}},{key:"transform",value:function(e,n){if(e.baseLength!==n.baseLength)throw new Error("Both operations have to have the same base length");for(var r=new t,i=new t,o=e.clone().ops,s=n.clone().ops,a=0,u=0,l=o[a++],h=s[u++];void 0!==l||void 0!==h;)if(l&&l.isInsert())r.insert(l.text,l.attributes),i.retain(l.text.length),l=o[a++];else if(h&&h.isInsert())r.retain(h.text.length),i.insert(h.text,h.attributes),h=s[u++];else{if(void 0===l)throw new Error("Cannot transform operations: first operation is too short.");if(void 0===h)throw new Error("Cannot transform operations: first operation is too long.");var c;if(l.isRetain()&&h.isRetain()){var f=t.transformAttributes(l.attributes,h.attributes);l.chars>h.chars?(c=h.chars,l.chars-=h.chars,h=s[u++]):l.chars===h.chars?(c=h.chars,l=o[a++],h=s[u++]):(c=l.chars,h.chars-=l.chars,l=o[a++]),r.retain(c,f[0]),i.retain(c,f[1])}else if(l.isDelete()&&h.isDelete())l.chars>h.chars?(l.chars-=h.chars,h=s[u++]):l.chars===h.chars?(l=o[a++],h=s[u++]):(h.chars-=l.chars,l=o[a++]);else if(l.isDelete()&&h.isRetain())l.chars>h.chars?(c=h.chars,l.chars-=h.chars,h=s[u++]):l.chars===h.chars?(c=h.chars,l=o[a++],h=s[u++]):(c=l.chars,h.chars-=l.chars,l=o[a++]),r.delete(c);else{if(!l.isRetain()||!h.isDelete())throw new Error("The two operations aren't compatible");l.chars>h.chars?(c=h.chars,l.chars-=h.chars,h=s[u++]):l.chars===h.chars?(c=l.chars,l=o[a++],h=s[u++]):(c=l.chars,h.chars-=l.chars,l=o[a++]),i.delete(c)}}return[r,i]}}]),t}()},{"./TextAction.js":11,"./Utils.js":14}],13:[function(t,e,n){"use strict";var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=t("./WrappedOperation.js"),o="normal";e.exports=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.maxItems=e||50,this.state=o,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}return r(t,[{key:"add",value:function(t,e){if("undoing"===this.state)this.redoStack.push(t),this.dontCompose=!0;else if("redoing"===this.state)this.undoStack.push(t),this.dontCompose=!0;else{var n=this.undoStack;!this.dontCompose&&e&&n.length>0?n.push(t.compose(n.pop())):(n.push(t),n.length>this.maxItems&&n.shift()),this.dontCompose=!1,this.redoStack=[]}}},{key:"transform",value:function(t){this.undoStack=this._transformStack(this.undoStack,t),this.redoStack=this._transformStack(this.redoStack,t)}},{key:"_transformStack",value:function(t,e){for(var n=[],r=t.length-1;r>=0;r--){var o=i.transform(t[r],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||n.push(o[0]),e=o[1]}return n.reverse()}},{key:"performUndo",value:function(t){if(this.state="undoing",!this.canUndo())throw new Error("can not undo, undo stack is empty");t(this.undoStack.pop()),this.state=o}},{key:"performRedo",value:function(t){if(this.state="redoing",!this.canRedo())throw new Error("can not redo, redo stack is empty");t(this.redoStack.pop()),this.state=o}},{key:"canUndo",value:function(){return!!this.undoStack.length}},{key:"canRedo",value:function(){return!!this.redoStack.length}},{key:"isUndoing",value:function(){return"undoing"===this.state}},{key:"isRedoing",value:function(){return"redoing"===this.state}}]),t}()},{"./WrappedOperation.js":15}],14:[function(t,e,n){"use strict";var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();e.exports=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}return r(t,null,[{key:"assert",value:function(t,e){if(!t)throw new Error(e||"assertion error")}},{key:"shallowClone",value:function(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}},{key:"shallowEqual",value:function(t,e){var n=Object.getOwnPropertyNames(t),r=Object.getOwnPropertyNames(e);if(n.length!==r.length)return!1;var i=!0,o=!1,s=void 0;try{for(var a,u=n[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var l=a.value;if(t[l]!==e[l])return!1}}catch(t){o=!0,s=t}finally{try{!i&&u.return&&u.return()}finally{if(o)throw s}}return!0}},{key:"cmpPos",value:function(t,e){return t.line-e.line||t.ch-e.ch}},{key:"posEq",value:function(e,n){return 0===t.cmpPos(e,n)}},{key:"posLe",value:function(e,n){return t.cmpPos(e,n)<=0}},{key:"makeEventEmitter",value:function(t,e,n){var r=n;t.prototype._allowedEvents=e,t.prototype._validateEventType=function(t){var e=!1;if(r._allowedEvents&&r._allowedEvents.length&&(e=r._allowedEvents.find(function(e){return e===t})),!e)throw new Error('Unknown event "'+t+'"')},t.prototype.on=function(t,e,n){r._validateEventType(t),r._eventListeners=r._eventListeners||{},r._eventListeners[t]=r._eventListeners[t]||[],r._eventListeners[t].push({callback:e,context:n})},t.prototype.off=function(t,e){if(r._validateEventType(t),r._eventListeners){r._eventListeners=r._eventListeners||{};for(var n=r._eventListeners[t]||[],i=0;i<n.length;i++)if(n[i].callback===e)return void n.splice(i,1)}},t.prototype.trigger=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if(r._validateEventType(t),r._eventListeners)for(var o=r._eventListeners[t]||[],s=0;s<o.length;s++){var a=o[s].callback;a&&a.apply(o[s].context,n)}}}},{key:"addStyleWithCSS",value:function(t){if(t||t.length){var e=document.createElement("style");e.type="text/css",e.appendChild(document.createTextNode(t));(window.SharedPenRoot||document.documentElement.getElementsByTagName("head")[0]).appendChild(e)}}},{key:"emptyAttributes",value:function(t){for(var e in t)return!1;return!0}},{key:"elt",value:function(t,e,n){var r=document.createElement(t);if("string"==typeof e)r.innerHTML="",r.appendChild(document.createTextNode(e));else if(e&&e instanceof Array)for(var i=0;i<e.length;i++)r.appendChild(e[i]);for(var o in n||{})r.setAttribute(o,n[o]);return r}},{key:"on",value:function(t,e,n,r){t.addEventListener?t.addEventListener(e,n,r||!1):t.attachEvent&&t.attachEvent("on"+e,n)}},{key:"off",value:function(t,e,n,r){t.removeEventListener?t.removeEventListener(e,n,r||!1):t.detachEvent&&t.detachEvent("on"+e,n)}},{key:"preventDefault",value:function(t){t.preventDefault?t.preventDefault():t.returnValue=!1}},{key:"stopPropagation",value:function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0}},{key:"stopEvent",value:function(e){t.preventDefault(e),t.stopPropagation(e)}},{key:"stopEventAnd",value:function(e){return function(n){return e(n),t.stopEvent(n),!1}}},{key:"hueFromName",value:function(t){for(var e=1,n=0;n<t.length;n++)e=17*(e+t.charCodeAt(n))%360;return e/360}},{key:"hsl2hex",value:function(t,e,n){var r=function(t,e,n){function r(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+r(t)+r(e)+r(n)};if(0===e)return r(n,n,n);var i=n<.5?n*(1+e):n+e-e*n,o=2*n-i,s=function(t){return t<0&&(t+=1),t>1&&(t-=1),6*t<1?o+6*(i-o)*t:2*t<1?i:3*t<2?o+6*(i-o)*(2/3-t):o};return r(s(t+1/3),s(t),s(t-1/3))}}]),t}()},{}],15:[function(t,e,n){"use strict";function r(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function i(t,e){return t&&"object"===(void 0===t?"undefined":s(t))&&"function"==typeof t.transform?t.transform(e):t}var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};e.exports=function(){function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.wrapped=e,this.meta=n}return o(t,[{key:"apply",value:function(){return this.wrapped.apply.apply(this.wrapped,arguments)}},{key:"invert",value:function(){var e=this.meta;return e&&"object"===(void 0===e?"undefined":s(e))&&"function"==typeof e.invert&&(e=this.meta.invert.apply(e,arguments)),new t(this.wrapped.invert.apply(this.wrapped,arguments),e)}},{key:"compose",value:function(e){return new t(this.wrapped.compose(e.wrapped),function(t,e){if(t&&"object"===(void 0===t?"undefined":s(t))){if("function"==typeof t.compose)return t.compose(e);var n={};return r(t,n),r(e,n),n}return e}(this.meta,e.meta))}},{key:"transform",value:function(e){return t.transform(this,e)}}],[{key:"transform",value:function(e,n){var r=e.wrapped.transform(n.wrapped);return[new t(r[0],i(e.meta,n.wrapped)),new t(r[1],i(n.meta,e.wrapped))]}}]),t}()},{}]},{},[10])(10)});