<link rel="import" href="toolbar/toolbar-normal-button.html">
<link rel="import" href="toolbar/toolbar-menu-button.html">
<link rel="import" href="toolbar/toolbar-dropdown-list.html">

<dom-module id="toolbox-toolbar">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 35px;
        border-top: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;

        display: flex;
        justify-content: center;
        align-items: center;
      }
      .toolbar-separator {
        border-left: 1px solid #e0e0e0;
        margin: 0 3px;
        width: 0;
        height: 35px;
        user-select: none;
      }
      toolbar-menu-button#font {
        --caption-with: 70px;
      }
      toolbar-menu-button#font-size {
        --caption-with: 45px;
      }
    </style>
    <!-- undo/redo -->
    <template is="dom-repeat" items="[[undoItems]]">
      <toolbar-normal-button type="[[item.type]]" tooltip="[[item.tooltip]]"></toolbar-normal-button>
    </template>
    <div class="toolbar-separator"></div>
    <!-- font/font-size -->
    <template is="dom-repeat" items="[[fontItems]]">
      <toolbar-menu-button
        id$="[[item.type]]"
        type="[[item.type]]"
        tooltip="[[item.tooltip]]"
        caption="[[item.caption]]"
        items="[[item.items]]"></toolbar-menu-button>
      <div class="toolbar-separator"></div>
    </template>
    <!-- bold/italic/underline/strike -->
    <template is="dom-repeat" items="[[formatItems]]">
      <toolbar-normal-button
      type$="[[item.type]]"
      tooltip="[[item.tooltip]]"
      selected$="[[_monitorAttrsSelected(item.type,currentSelectedStates)]]"></toolbar-normal-button>
    </template>
    <div class="toolbar-separator"></div>
    <!-- color/highlight color -->
    <!-- TODO -->
    <div style="font-family: Arial;">TODO: color</div>
    <div class="toolbar-separator"></div>

    <!-- align(left, center, right, justify) -->
    <template is="dom-repeat" items="[[alignItems]]">
      <toolbar-normal-button
        type$="[[item.type]]"
        tooltip="[[item.tooltip]]"
        selected$="[[_monitorAttrsSelected(item.type,currentSelectedStates)]]"></toolbar-normal-button>
    </template>
    <div class="toolbar-separator"></div>
    <!-- list(order, unorder, todo) -->
    <template is="dom-repeat" items="[[listItems]]">
      <toolbar-normal-button
        type$="[[item.type]]"
        tooltip="[[item.tooltip]]"
        selected$="[[_monitorAttrsSelected(item.type,currentSelectedStates)]]"></toolbar-normal-button>
    </template>
    <div class="toolbar-separator"></div>
    <!-- indent/unindent -->
    <template is="dom-repeat" items="[[indentItems]]">
      <toolbar-normal-button type="[[item.type]]" tooltip="[[item.tooltip]]"></toolbar-normal-button>
    </template>
    <div class="toolbar-separator"></div>


    <toolbar-dropdown-list id="dropdown"></toolbar-dropdown-list>
  </template>
  <script>
    class ToolboxToolbar extends Polymer.Element {
      static get is () {
        return 'toolbox-toolbar'
      }
      static get properties () {
        return {
          undoItems: {
            type: Array,
            value: [{
              type: 'undo',
              tooltip: 'Undo (⌘Z)'
            }, {
              type: 'redo',
              tooltip: 'Rndo (⌘Y)'
            }]
          },
          formatItems: {
            type: Array,
            value: [{
              type: 'bold',
              tooltip: ''
            }, {
              type: 'italic',
              tooltip: ''
            }, {
              type: 'underline',
              tooltip: ''
            }, {
              type: 'strike',
              tooltip: ''
            }]
          },
          fontItems: {
            type: Array,
            value: [{
              type: 'font',
              tooltip: 'Font',
              caption: 'Arial',
              items: ['Arial', 'Consolas', 'Calibri']
            }, {
              type: 'font-size',
              tooltip: 'Font size',
              caption: '16',
              items: [16, 18, 20, 24, 30, 40]
            }]
          },
          alignItems: {
            type: Array,
            value: [{
              type: 'align-left',
              tooltip: 'Left align (⌘+Shift+L)'
            }, {
              type: 'align-center',
              tooltip: 'Center align (⌘+Shift+E)'
            }, {
              type: 'align-right',
              tooltip: 'Right align (⌘+Shift+R)'
            }, {
              type: 'align-justify',
              tooltip: 'Justify (⌘+Shift+J)'
            }]
          },
          listItems: {
            type: Array,
            value: [{
              type: 'ordered-list',
              tooltip: ''
            }, {
              type: 'unordered-list',
              tooltip: ''
            }, {
              type: 'todo-list',
              tooltip: ''
            }]
          },
          indentItems: {
            type: Array,
            value: [{
              type: 'indent',
              tooltip: 'Indent (⌘[)'
            }, {
              type: 'unindent',
              tooltip: 'Unindent (⌘[)'
            }]
          },
          currentSelectedStates: Object
        }
      }
      connectedCallback () {
        super.connectedCallback()
        this._toolbarBtnTapHandler = (evt) => {
          let type = evt.detail.type
          if (type === 'font' || type === 'font-size') {
            let isOpen = evt.detail.isOpen
            if (isOpen) {
              let items = evt.detail.items
              let position = evt.detail.position
              let selected = evt.detail.selected
              this.$.dropdown.openDropdownList(type, items, selected, position)
            } else {
              this.$.dropdown.closeDropdownList()
            }
          } else {
            this.execCommand(type)
          }
        }
        this._dropdownSelectHandler = (evt) => {
          let type = evt.detail.type
          let selected = evt.detail.selected
          let index = this.fontItems.findIndex(item => item.type === type)

          this.set(`fontItems.${index}.caption`, selected)
          this.execCommand(type, selected)
        }
        this._dropdownCloseHandler = (evt) => {
          let type = evt.detail.type
          let menuBtn = this.shadowRoot.querySelector(`#${type}`)
          menuBtn && menuBtn.relatedDropdownListClose && menuBtn.relatedDropdownListClose()
        }

        window.addEventListener('toolbar-button-tap', this._toolbarBtnTapHandler.bind(this))
        window.addEventListener('toolbar-dropdown-select', this._dropdownSelectHandler.bind(this))
        window.addEventListener('toolbar-dropdown-close', this._dropdownCloseHandler.bind(this))

        // setTimeout to add realtimeTextAttrsChanged event listener,
        // ensure the sharedPen has been initialized
        setTimeout(this.handleRealtimeTextAttrsSelected.bind(this))
      }
      disconnectedCallback() {
        super.disconnectedCallback()

        window.removeEventListener('toolbar-button-tap', this._toolbarBtnTapHandler.bind(this))
        window.removeEventListener('toolbar-dropdown-select', this._dropdownSelectHandler.bind(this))
        window.removeEventListener('toolbar-dropdown-close', this._dropdownCloseHandler.bind(this))
      }

      execCommand(command, value) {
        console.log('[execCommand]: ', command, value)
        switch (command) {
          case 'undo': window.sharedPen.undo(); break
          case 'redo': window.sharedPen.redo(); break

          case 'font': window.sharedPen.font(value); break
          case 'font-size':  window.sharedPen.fontSize(value); break

          case 'bold': window.sharedPen.bold(); break
          case 'italic': window.sharedPen.italic(); break
          case 'underline': window.sharedPen.underline(); break
          case 'strike': window.sharedPen.strike(); break

          case 'align-left':
          case 'align-center':
          case 'align-right':
          case 'align-justify': window.sharedPen.align(command.substr(command.indexOf('-')+1)); break

          case 'ordered-list': window.sharedPen.orderedList(); break
          case 'unordered-list': window.sharedPen.unorderedList(); break
          case 'todo-list': window.sharedPen.todoList(); break

          case 'indent': window.sharedPen.indent(); break
          case 'unindent': window.sharedPen.unindent(); break
        }
      }
      // 实时显示当前文本属性状态
      handleRealtimeTextAttrsSelected () {
        window.sharedPen.on('realtimeTextAttrsChanged', (attrs) => {
          this.set('currentSelectedStates', attrs)
        })
      }
      // 文本属性按键监听是否选中
      _monitorAttrsSelected (type, currentSelectedStates) {
        if (!currentSelectedStates) { return false }
        switch (type) {
          case 'bold': return this._checkedSelectedStates(currentSelectedStates, 'b')
          case 'italic': return this._checkedSelectedStates(currentSelectedStates, 'i')
          case 'underline': return this._checkedSelectedStates(currentSelectedStates, 'u')
          case 'strike': return this._checkedSelectedStates(currentSelectedStates, 's')

          case 'align-left':
          case 'align-center':
          case 'align-right':
          case 'align-justify':
            var laValue = type.substr(type.indexOf('-')+1)
            return this._checkedSelectedStates(currentSelectedStates, 'la', laValue)

          case 'ordered-list': return this._checkedSelectedStates(currentSelectedStates, 'lt', 'o')
          case 'unordered-list': return this._checkedSelectedStates(currentSelectedStates, 'lt', 'u')
          case 'todo-list': return this._checkedSelectedStates(currentSelectedStates, 'lt')
        }
      }
      _checkedSelectedStates (currentSelectedStates, type, value) {
        if (type in currentSelectedStates) {
          if (type === 'lt' && !value) {
            return currentSelectedStates[type] === 't' || currentSelectedStates[type] === 'tc'
          } else {
            return currentSelectedStates[type] === true || currentSelectedStates[type] === value
          }
        } else if (type === 'la') {
          return value === 'left' // align default: left
        } else {
          return false
        }
      }
    }
    window.customElements.define(ToolboxToolbar.is, ToolboxToolbar)
  </script>
</dom-module>
